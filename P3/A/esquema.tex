\documentclass[11pt,a4paper]{article}

\usepackage[latin1]{inputenc} 
%\usepackage[T1]{fontenc} 
\usepackage[spanish]{babel}
\decimalpoint
\setlength{\parskip}{0.5\baselineskip} 
\usepackage{fullpage}
\usepackage[procnames]{listings}
\usepackage{fancyhdr}
\usepackage{lastpage}
\usepackage{xcolor}
\usepackage{booktabs}
\usepackage{graphicx}
\usepackage{subcaption}
\usepackage[fleqn]{amsmath}
\parindent 0in 
\setlength{\mathindent}{0pt}
\usepackage{float}

%% DEFINICIONES
\newcommand{\TODO}[1]{{\huge \color{red} \textbf{TODO: }#1 }}
\newcommand{\todo}[1]{{\large \color{red} \textbf{TODO: }#1 }}

\lstset{%
  % backgroundcolor=\color{yellow!20},%
  basicstyle=\ttfamily,%
  numbers=left, numberstyle=\scriptsize, stepnumber=1, numbersep=5pt,%
  frame=single%
}%



\title{Sistemas de Gestión de Datos y de la Información\\Práctica 3:
  MongoDB}
\author{Luis M. Costero Valero --- Jesús J. Doménech Arellano}
\date{22 de enero de 2016}

\begin{document} 
\maketitle

\textbf{Descripción del esquema implícito escogido:}\\
Para el diseño de la base de datos del sitio de preguntas propuesto en la
práctica, se ha considerado la creación de 4 colecciones para almacenar los
usuarios, las preguntas, las contestaciones y comentarios, y las
puntuaciones respectivamente.
A continuación se muestra el esquema de cada una de las colecciones
utilizadas, y las razones que se han considerado para su diseño:\\

\textbf{Usuarios:}\\

\begin{table}[h] \centering
  \begin{tabular}{@{}llll@{}} \toprule 
    Campo && Tipo & Descripción \\ \midrule 
    \_id            && ObjectId & Identificador único de la instancia \\
    alias           && Texto & Identificador único del usuario \\
    nombre          && Texto & Nombre del usuario \\
    apellidos       && Texto & Apellidos del usuario \\
    experiencia     && [Texto] & Array con los temas que domina el usuarios \\
    fecha\_creacion && Date & Fecha de creación \\
              & \multicolumn{1}{|l}{calle} & Texto & Dirección del usuario \\
    dirección & \multicolumn{1}{|l}{pais} & Texto & Pais del usuario \\
              & \multicolumn{1}{|l}{ciudad} & Texto & Ciudad del usuario \\
              & \multicolumn{1}{|l}{numero} & Texto & Número de la viviendo \\
    \bottomrule
\end{tabular}
\end{table}


De este diseña destacar que la dirección se encuentra un objeto JSON
anidado en la tabla, en vez de referenciado ya que este posee poco tamaño y
no va a sufrir muchos cambios. Asimismo, se ha decidido no tener
referencias desde un usuario a las preguntas, respuestas, comentarios o
votaciones que realiza en el sitio, sino que el resto de colecciones tengan
referencias a los usuarios.\\

A continuación se muestra un ejemplo de usuario en la colección: \\
\newpage{}
\begin{figure}[!h]
\begin{lstlisting}
{"_id":{"$oid":"569d39751204b70e83ab2fbd"},
 "nombre":"Sherlock",
 "apellidos":"Holmes",
 "alias":"ShW",
 "experiencia":["SQL", "Tor", "recovering"],
 "fecha_creacion":{"$date":"2016-01-18T19:13:57.966Z"},
 "direccion":{"calle":"Baker Street",
	      "pais":"England",
	      "ciudad":"London",
	      "numero":"221B"}
}
\end{lstlisting}
\end{figure}



\textbf{Preguntas:}\\


\begin{table}[h] \centering
  \begin{tabular}{@{}lll@{}} \toprule 
    Campo & Tipo & Descripción \\ \midrule 
    \_id     & ObjectId & Identificador único de la instancia \\
    alias    & Texto & Referencia al alias del usuario que preguntó \\
    titulo   & Texto & Título de la pregunta \\
    texto    & Texto & Cuerpo de la pregunta \\
    tags     & [Texto] & Array con los temas de los que trata la pregunta \\
    fecha\_creacion & Date & Fecha de creación \\
    respuestas & [ObjectId] & Array con referencias a los ids de las
                              respuestas a esta pregunta \\
    \bottomrule
\end{tabular}
\end{table}

Se ha decidido separar las preguntas en una colección distinta a los
usuarios ya que estas van a ser numerosas y no acotadas. Para mantener la
referencia con el usuario que ha creado la pregunta, se almacena el alias
del usuario (identificador único para cada usuario). De esta manera se
consigue obtener el alias del usuario que ha creado la pregunta sin
necesidad de consultar la colección de usuarios.

Puesto que las respuestas son ilimitadas, y además pueden llegar a tener un
gran tamaño (pueden incluir contenido multimedia), se ha decidido tener un
array de ObjectId correspondiente a los identificadores únicos de las
respuestas que tiene la pregunta. De esta manera, además se consigue que
para obtener el número de respuestas de una pregunta solo sea necesario
obtener la longitud de ese array.

Por último, para agilizar las búsquedas y obtener todas las preguntas de un usuario, se
deberá tener un índice sobre el campo ``alias''.

Un ejemplo de documento de esta colección sería:
\begin{figure}[H]
  \centering
\begin{lstlisting}
{"_id":{"$oid":"569d3a341204b70e9ce41037"},
 "titulo":"POO en javascript"},
 "texto":"Como funciona la orientación a objetos basada en 
          prototipos?",
 "tags":["javascript", "poo"],
 "fecha_creacion":{"$date":"2016-01-18T19:17:08.131Z"},
 "alias":"ShW",
 "respuestas":[{"$oid":"569d3d4f1204b7129cd4fdef"},
	       {"$oid":"569d3d4f1204b7129cd4fdf0"},
	       {"$oid":"569d3f9e1204b712cd7d58d7"},
	       {"$oid":"569d3f9e1204b712cd7d58d8"},
	       {"$oid":"569d3ff71204b712d7415645"},
	       {"$oid":"569d3ff71204b712d7415646"}]
\end{lstlisting}
\end{figure}


\textbf{Respuestas y comentarios:}
\begin{table}[h] \centering
  \begin{tabular}{@{}llll@{}} \toprule 
    Campo && Tipo & Descripción \\ \midrule 
    \_id            && ObjectId & Identificador único de la instancia \\
    alias           && Texto & Identificador único del usuario que ha
                               realizado la respuesta \\
    votos\_pos       && Int  & Número de votos positivos \\
    votos\_neg       && Int & Número de votos negativos \\
    pregunta\_id     && ObjectId & Identificador de la pregunta a la que responde \\
    fecha\_creacion && Date & Fecha de creación \\
    comentarios && [comentario] & Array de comentarios como se describen a
                                   continuación\\
    \bottomrule
  \end{tabular}
\end{table}

Donde un comentario viene definido por la siguiente estructura:
\begin{table}[h] \centering
  \begin{tabular}{@{}llll@{}} \toprule 
    Campo && Tipo & Descripción \\ \midrule 
    alias && Texto & Identificador único del usuario que ha creado el comentario \\
    fecha\_creacion && Date & Fecha de creación \\
    texto && Texto & Texto del comentario \\
    \bottomrule
\end{tabular}
\end{table}

\begin{figure}[H]
  \centering
\begin{lstlisting}
{"_id":{"$oid":"569d3f9e1204b712cd7d58d8"},
 "alias":"alias",
 "votos_pos":0,
 "votos_neg":1,
 "pregunta_id":{"$oid":"569d3a341204b70e9ce41037"},
 "fecha_creacion":{"$date":"2016-01-18T19:40:14.709Z"},
 "texto":"Mira esta URL: aquí te lo explican ....",
 "comentarios":[{"alias":"Poison",
		 "fecha_creacion":{"$date":"2016-01-18T19:41:43.107Z"},
		 "texto":"Esto es un comentario a tu respuesta. 
                          Muy buena!"}]
}
 
\end{lstlisting}
\end{figure}




\textbf{Votaciones:}
\begin{table}[h] \centering
  \begin{tabular}{@{}lll@{}} \toprule 
    Campo & Tipo & Descripción \\ \midrule 
    \_id & ObjectId & Identificador único de la instancia \\
    respuesta\_id & ObjectId & Identificador de la respuesta a la que se ha
                              votado \\
    alias & Text & Identificador único del usuario \\
    voto & Int & Valor del voto \\
    titulo & Text & Título de la pregunta en la que está el comentario \\
    fecha\_creacion & Date & Fecha del voto \\
    \bottomrule
\end{tabular}
\end{table}



\begin{figure}[H]
  \centering
\begin{lstlisting}
{"_id":{"$oid":"569e20e11204b70e4eb8bf09"},
 "respuesta_id":{"$oid":"569d3f9e1204b712cd7d58d7"},
 "alias":"ShW",
 "voto":1,
 "titulo":"Titulo sobre javascript",
 "fecha_creacion":{"$date":"2016-01-19T11:41:21.018Z"}
}
\end{lstlisting}
\end{figure}



\vspace{2cm}
\hrule
\begin{center}\textcolor{red}{DESDE AQUI ES TODO VIEJO}\end{center}
\hrule
\vspace{2cm}

Las consideraciones que se han tomado para realizar este esquema han sido:\\

-- Separar preguntas de comentarios y respuestas ya que los comentarios no
tienen un numero acotado, y ademas al contener multimedia van a ser
grandes. (más cosas??)\\
-- La pregunta referencia a las contestaciones para que así se pueda saber
el número de contestaciones sin necesidad de consulatar la coleccion.\\
-- Se ha decidido separar la información de puntuaciones a otra tabla
porque se prevee que va a haber muchas escrituras y lecturas de
estas. Además, esto permite obtener todas las puntutaciones de un usuario
de manera sencilla.\\
-- Aunque las valoraciones están en una coleccion independiente, los
documentos de respuestas lelvan un contador de votos positivos y negativos
para mostrar esa información al consultar una respuesta.\\
-- Los comentarios se encuentran anidados a las respuestas para no tener
que añadir un campo más referenciando a la contestación que comentan, y
además conseguir que la coleccion almacene un único tipo de documento.\\
-- Las preguntas tienen referencias a las respuestas, pero no el texto
duplicado, ya que aunque se pierda velocidad en el acceso, como los
comentarios no son acotados y pueden tener multimedia se perdería muchos
datos al duplicarlo.\\
-- Mas cosas que he pensado (y mucho) pero ahora no me vienen a la cabeza\\


\end{document}



%
%
%%%
%%% Local Variables:
%%% mode: latex
%%% TeX-master: "./esquema.tex"
%%% End:
